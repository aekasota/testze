<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Central de Atendimento</title>
  <!-- Fonte Nunito -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,600;1,600&amp;display=swap" rel="stylesheet">
  <!-- Link para o CSS externo -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Central de Atendimento</h1>
    <button id="toggleMode" class="mode-toggle">üåô</button>
  </header>
  
  <!-- Barra de abas ‚Äì grupo centralizado -->
  <div id="tabsContainer" class="tabs-container"></div>
  
  <!-- √Årea principal de conte√∫do -->
  <div id="contentContainer" class="content-container">
    <!-- Tela de Boas-vindas -->
    <div id="welcomePage" class="card welcome-page animated">
      <h2>Bem-vindo √† Central de Atendimento!</h2>
      <p>Clique no bot√£o abaixo para come√ßar a trabalhar.</p>
      <button id="startWorkBtn" class="btn">Come√ßar a trabalhar</button>
    </div>
  </div>

  <!-- Mensagem fixa de teste no rodap√© -->
  <div id="testMessage" class="test-message">Apenas tratativa de produtos vencidos configurada at√© o momento.</div>
  <div id="testMessage1" class="test-message1">With Love, Hyak. ‚ô°</div>
  
  <script>
    /*************************************************************************************
     * Fluxo:
     * 1. Tela de boas-vindas ‚Üí Cria√ß√£o de ticket (cada ticket em sua aba com formul√°rio)
     * 2. Ap√≥s inserir o n√∫mero do ticket, inicia-se a √°rea de operativa:
     *    - Inicialmente, o header exibe "Selecione a operativa" e o bot√£o "Problemas com o Pedido".
     *    - Ao clicar, o header atualiza para "Operativa: Problemas com o Pedido" e as op√ß√µes de tratativa
     *      aparecem com anima√ß√£o.
     * 3. Na tela de tratativas, ao selecionar uma op√ß√£o:
     *    - Se for a configurada (data-option="4"), o fluxo de passos inicia com anima√ß√£o.
     *    - Para as demais, exibe "Tratativa n√£o configurada." e finaliza o ticket (com anima√ß√£o de fade-out/in no bloco final).
     * 4. Quando um passo final (isFinal: true) √© alcan√ßado, o √∫ltimo passo permanece vis√≠vel e, abaixo, um bloco
     *    final (com fade‚Äëin) √© acrescentado exibindo, √† esquerda, o bot√£o "Fechar Ticket" e, √† direita, a mensagem
     *    "Ticket <b>[n√∫mero]</b> finalizado em: [data/hora]".
     * 5. Ao fechar o ticket, √© aplicado um fade-out antes da remo√ß√£o do conte√∫do.
     *************************************************************************************/
    
    document.addEventListener("DOMContentLoaded", function(){
      showWelcomePage();
      document.getElementById("toggleMode").addEventListener("click", toggleTheme);
    });
    
    function toggleTheme(){
      document.body.classList.toggle("dark-mode");
      document.getElementById("toggleMode").innerText =
        document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
    }
    
    // Exibe a tela de boas-vindas com anima√ß√£o
    function showWelcomePage(){
      const contentContainer = document.getElementById("contentContainer");
      contentContainer.innerHTML = `
        <div id="welcomePage" class="card welcome-page animated">
          <h2>Bem-vindo √† Central de Atendimento!</h2>
          <p>Clique no bot√£o abaixo para come√ßar a trabalhar.</p>
          <button id="startWorkBtn" class="btn">Come√ßar a trabalhar</button>
        </div>`;
      document.getElementById("tabsContainer").innerHTML = "";
      document.getElementById("startWorkBtn").addEventListener("click", createTicket);
    }
    
    let ticketCounter = 0;
    let tickets = {};
    
    // Cria um novo ticket (aba) e n√£o remove os anteriores.
    function createTicket(){
      ticketCounter++;
      const ticketId = "ticket-" + ticketCounter;
      const contentContainer = document.getElementById("contentContainer");
      
      // Se estiver na tela de boas-vindas, limpa e configura as abas
      if(document.getElementById("welcomePage")){
        contentContainer.innerHTML = "";
        document.getElementById("tabsContainer").innerHTML = "";
        addPlusButton();
      }
      
      // Cria o cart√£o do ticket com o formul√°rio (adiciona classe "animated")
      const ticketCard = document.createElement("div");
      ticketCard.className = "ticket-tab card animated";
      ticketCard.id = ticketId;
      ticketCard.innerHTML = `
        <div class="ticket-form">
          <p class="ticket-label">Informe o n√∫mero do ticket:</p>
          <input type="text" id="ticketInput-${ticketId}" class="ticket-code" maxlength="10" placeholder="Ex: 123456">
          <button class="btn" id="ticketSubmit-${ticketId}">Confirmar</button>
        </div>`;
      contentContainer.appendChild(ticketCard);
      
      // Cria a aba correspondente com anima√ß√£o
      const tabHeader = document.createElement("div");
      tabHeader.className = "tab animated";
      tabHeader.id = "header-" + ticketId;
      tabHeader.innerText = "Novo Ticket";
      tabHeader.addEventListener("click", () => switchTicket(ticketId));
      document.getElementById("tabsContainer").insertBefore(tabHeader, document.getElementById("addTab"));
      
      tickets[ticketId] = { number: null };
      switchTicket(ticketId);
      
      document.getElementById("ticketSubmit-" + ticketId).addEventListener("click", function(){
        const num = document.getElementById("ticketInput-" + ticketId).value.trim();
        if(!num){
          alert("Informe o n√∫mero do ticket.");
          return;
        }
        tickets[ticketId].number = num;
        document.getElementById("header-" + ticketId).innerText = num;
        // Aplica anima√ß√£o para a transi√ß√£o da tela de operativa.
        loadOperativeFlow(ticketId);
      });
    }
    
    // Adiciona o bot√£o "+" √† direita do grupo de abas.
    function addPlusButton(){
      const tabsContainer = document.getElementById("tabsContainer");
      const plusBtn = document.createElement("div");
      plusBtn.id = "addTab";
      plusBtn.className = "tab add-tab animated";
      plusBtn.innerText = "+";
      tabsContainer.appendChild(plusBtn);
      plusBtn.addEventListener("click", createTicket);
    }
    
    // Alterna entre os tickets, exibindo somente a aba selecionada com fadeIn.
    function switchTicket(ticketId){
      const ticketTabs = document.getElementsByClassName("ticket-tab");
      Array.from(ticketTabs).forEach(div => {
        div.style.display = "none";
        div.classList.remove("animated");
      });
      const selectedTicket = document.getElementById(ticketId);
      selectedTicket.style.display = "block";
      selectedTicket.classList.add("animated");
      
      const headers = document.getElementsByClassName("tab");
      Array.from(headers).forEach(h => { h.classList.remove("active"); });
      document.getElementById("header-" + ticketId).classList.add("active");
    }
    
    // Finaliza o ticket com anima√ß√£o de fadeOut (aplicada via CSS) e remove-o.
    function closeTicket(ticketId){
      const header = document.getElementById("header-" + ticketId);
      const content = document.getElementById(ticketId);
      if(header && content){
        header.classList.add("fadeOut");
        content.classList.add("fadeOut");
        // Ap√≥s o tempo da anima√ß√£o (500ms), remove os elementos.
        setTimeout(() => {
          header.remove();
          content.remove();
          delete tickets[ticketId];
          const remaining = document.getElementsByClassName("ticket-tab");
          if(remaining.length > 0){
            switchTicket(remaining[0].id);
          } else {
            showWelcomePage();
          }
        }, 500);
      }
    }
    
    /************************************************************
     * FLUXO DA OPERATIVA / TRATATIVA ‚Äì COMPLETO, COM ANIMA√á√ïES
     ************************************************************/
    
    // Tela inicial da operativa: Exibe "Selecione a operativa" e um bot√£o "Problemas com o Pedido"
    function loadOperativeFlow(ticketId){
      let ticketDiv = document.getElementById(ticketId);
      ticketDiv.innerHTML = `
        <div class="operative-header animated">
          <span class="current-treatment">Selecione a operativa</span>
        </div>
        <div class="operative-initial animated">
          <button class="btn" id="startOperativaBtn">Problemas com o Pedido</button>
        </div>`;
      switchTicket(ticketId);
      
      document.getElementById("startOperativaBtn").addEventListener("click", function(){
        ticketDiv.querySelector(".current-treatment").innerText = "Operativa: Problemas com o Pedido";
        loadTratativeOptions(ticketId);
      });
    }
    
    // Exibe as 9 op√ß√µes de tratativas em coluna com anima√ß√£o.
    // Se o atendente selecionar a op√ß√£o configurada (data-option="4"), inicia o fluxo de passos.
    // Para as demais, exibe "Tratativa n√£o configurada." e finaliza o ticket.
    function loadTratativeOptions(ticketId){
      let ticketDiv = document.getElementById(ticketId);
      ticketDiv.innerHTML = `
        <div class="operative-header animated">
          <span class="current-treatment">Selecione a tratativa</span>
        </div>
        <div class="options animated">
          <button class="btn option" data-option="1">Minha bebida veio quente</button>
          <button class="btn option" data-option="2">Produto danificado, congelado, sabor alterado etc.</button>
          <button class="btn option" data-option="3">Meus produtos s√£o falsificados</button>
          <button class="btn option" data-option="4">Meus produtos vieram vencidos</button>
          <button class="btn option" data-option="5">Meu pedido veio errado</button>
          <button class="btn option" data-option="6">Faltou produto no meu pedido</button>
          <button class="btn option" data-option="7">Pedido cancelado e pedido desconsiderado</button>
          <button class="btn option" data-option="8">Mau atendimento do parceiro</button>
          <button class="btn option" data-option="9">Pedido Cancelado &gt; Estorno de pedido cancelado</button>
        </div>
        <div class="stepContainer animated"></div>`;
      
      let optionsDiv = ticketDiv.querySelector(".options");
      optionsDiv.style.flexDirection = "column";
      
      let optionButtons = ticketDiv.querySelectorAll(".option");
      optionButtons.forEach(function(btn){
        btn.addEventListener("click", function(){
          let chosen = btn.innerText;
          ticketDiv.querySelector(".current-treatment").innerText = "Operativa: " + chosen;
          optionsDiv.style.display = "none";
          let selectedOption = btn.getAttribute("data-option");
          if(selectedOption === "4"){
            startOperativeSteps(ticketDiv.querySelector(".stepContainer"), ticketId);
          } else {
            // Exibe a mensagem "Tratativa n√£o configurada." e finaliza o ticket (com anima√ß√£o)
            ticketDiv.querySelector(".stepContainer").innerHTML = "<p>Tratativa n√£o configurada.</p>";
            finalizeTicket(ticketId);
          }
        });
      });
    }
    
    // Fun√ß√£o para finalizar automaticamente o ticket para tratativas n√£o configuradas,
    // adicionando o bloco final com anima√ß√£o.
    function finalizeTicket(ticketId){
      let container = document.getElementById(ticketId).querySelector(".stepContainer");
      if(!container){
        container = document.createElement("div");
        container.className = "stepContainer";
        document.getElementById(ticketId).appendChild(container);
      }
      // N√£o limpa o conte√∫do: mant√©m a mensagem de "Tratativa n√£o configurada."
      const finalDiv = document.createElement("div");
      finalDiv.className = "final-container animated";
      const btnClose = document.createElement("button");
      btnClose.className = "btn";
      btnClose.innerText = "Fechar Ticket";
      btnClose.addEventListener("click", function(){
        closeTicket(ticketId);
      });
      const p = document.createElement("p");
      p.className = "final-date";
      const now = new Date();
      p.innerHTML = `Ticket <b>${tickets[ticketId].number}</b> finalizado em: ${now.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit", hour12:false })}`;
      finalDiv.style.display = "flex";
      finalDiv.style.justifyContent = "space-between";
      finalDiv.style.alignItems = "center";
      finalDiv.appendChild(btnClose);
      finalDiv.appendChild(p);
      container.appendChild(finalDiv);
    }
    
    // Fluxo completo dos passos para a tratativa configurada (op√ß√£o 4)
    const steps = [
      {
        id: 1,
        content: `<strong>1. Se apresente e acolha o cliente:</strong><br>
                  Resposta pr√©-definida: 1-Apresenta√ß√£o (se atendimento inicial)<br>
                  Resposta pr√©-definida: 24-Acolhimento ‚Äì geral`
      },
      {
        id: 2,
        content: `<strong>2. Solicite as evid√™ncias:</strong><br>
                  Informe que as evid√™ncias dos produtos (vencidos ou com defeito) dever√£o ser enviadas via v√≠deo.<br>
                  Resposta pr√©-definida: 177 - Solicita√ß√£o de dados e evid√™ncias<br>
                  <em>Escolha uma op√ß√£o:</em>`,
        choices: [
          { text: "N√£o possui/deseja enviar evid√™ncias", next: "2a" },
          { text: "Enviou as evid√™ncias", next: "2b" }
        ]
      },
      {
        id: "2a",
        content: `<strong>2.1 N√£o enviou evid√™ncias:</strong><br>
                  Ticket finalizado ‚Äì evid√™ncias necess√°rias para prosseguir.<br>
                  Resposta pr√©-definida: 178 - Finaliza√ß√£o sem evid√™ncias.`,
        isFinal: true
      },
      {
        id: "2b",
        content: `<strong>2.2 Evid√™ncias enviadas:</strong><br>
                  Validar as evid√™ncias conforme a quantidade mencionada.`
      },
      {
        id: 3,
        content: `<strong>3. Verifique a ingest√£o dos produtos:</strong><br>
                  <em>Escolha uma op√ß√£o:</em>`,
        choices: [
          { text: "Fez a ingest√£o", next: "3a" },
          { text: "N√£o fez a ingest√£o", next: "3b" }
        ]
      },
      {
        id: "3a",
        content: `<strong>3.1 Ingest√£o realizada:</strong><br>
                  Escale para Suporte Avan√ßado via T2 Email.<br>
                  Resposta pr√©-definida: 10/11 ‚Äì Transfer√™ncia para Suporte.<br>
                  Tabula√ß√£o: Casos cr√≠ticos ‚Äì produtos vencidos.`,
        isFinal: true
      },
      {
        id: "3b",
        content: `<strong>3.2 N√£o ingeriu os produtos:</strong><br>
                  Prosseguir para o pr√≥ximo passo.`
      },
      {
        id: 4,
        content: `<strong>4. Posicione o cliente e contate o PDV:</strong><br>
                  Resposta pr√©-definida: 90-Produto &gt; Processo de troca.<br>
                  Observa√ß√£o: De segunda a sexta, realizar 3 tentativas; de s√°bado e domingo, 1 tentativa.<br>
                  <em>Escolha uma op√ß√£o:</em>`,
        choices: [
          { text: "Sucesso com o PDV (Loja resolve)", next: "4a" },
          { text: "Sem sucesso com o PDV (Loja n√£o atende/resolver)", next: "4b" }
        ]
      },
      {
        id: "4a",
        content: `<strong>4.1 Sucesso com o PDV (Loja resolve):</strong><br>
                  Oriente o cliente conforme o posicionamento da loja.<br>
                  Resposta pr√©-definida: 91-Produto &gt; Loja realizar√° a troca.<br>
                  Resolver o ticket com: Casos cr√≠ticos ‚Äì Meus produtos s√£o falsificados.<br>
                  Campos: Solicita√ß√£o de Cupom: N√£o; Suspeita de fraude: Sim; Tentou contato: Sim.`,
        isFinal: true
      },
      {
        id: "4b",
        content: `<strong>4.2 Sem sucesso com o PDV:</strong><br>
                  (Loja n√£o atendeu ou n√£o ir√° resolver o problema.)`
      },
      {
        id: 5,
        content: `<strong>5. Valide a forma de pagamento:</strong><br>
                  <em>Escolha uma op√ß√£o:</em>`,
        choices: [
          { text: "Pagamento na entrega", next: "5a" },
          { text: "Pagamento online", next: "5b" }
        ]
      },
      {
        id: "5a",
        content: `<strong>5.1 Pagamento na entrega selecionado.</strong><br>
Operativa: Meus produtos s√£o falsificados<br><br>
<b>Se o preju√≠zo for menor que R$65:</b><br>
Ofertar cupom no valor do preju√≠zo (n√£o incluso frete).<br>
Resposta pr√©-definida: 180 - Cupom de Preju√≠zo<br><br>
<b>Se o cliente aceitou o cupom:</b><br>
Oriente que o cupom foi solicitado.<br>
Resposta pr√©-definida: 181 - Cupom solicitado<br>
Resolver o ticket com: Casos cr√≠ticos ‚Äì Meus produtos vieram vencidos.<br>
Campos: Solicita√ß√£o de Cupom: Sim; Tipo do cupom: Preju√≠zo; Valor: Informar; Suspeita: Sim/N√£o; Tentou contato: Sim; Distribuidor atendeu: Sim.`,
        isFinal: true
      },
      {
        id: "5b",
        content: `<strong>5.2 Pagamento online selecionado.</strong><br>
Operativa: Meus produtos s√£o falsificados<br><br>
Oriente que o cliente ser√° transferido para o time especializado.<br>
Escale o ticket para o Suporte Avan√ßado ‚Äì T2 Email.<br>
Utilize: Transfer√™ncia conforme o hor√°rio.<br>
Campos: Solicita√ß√£o de Cupom: N√£o; Suspeita: Sim/N√£o; Tentou contato: Sim; Distribuidor atendeu: Sim/N√£o; Data de validade: Informar.`,
        isFinal: true
      }
    ];
    
    let currentStep = 0;
    
    function startOperativeSteps(container, ticketId){
      currentStep = 0;
      renderStep();
      
      function renderStep(){
        container.innerHTML = "";
        let step = steps[currentStep];
        const div = document.createElement("div");
        div.className = "step animated";
        div.innerHTML = step.content;
        container.appendChild(div);
        
        if(step.choices && !step.isFinal){
          step.choices.forEach(function(choice){
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.innerText = choice.text;
            btn.addEventListener("click", function(){
              currentStep = steps.findIndex(s => s.id === choice.next);
              renderStep();
            });
            container.appendChild(btn);
          });
        } else if(!step.isFinal){
          const btnNext = document.createElement("button");
          btnNext.className = "btn";
          btnNext.innerText = "Pr√≥ximo";
          btnNext.addEventListener("click", function(){
            currentStep++;
            renderStep();
          });
          container.appendChild(btnNext);
        }
        
        if(step.isFinal){
          renderFinal();
        }
      }
      
      function renderFinal(){
        const finalDiv = document.createElement("div");
        finalDiv.className = "final-container animated";
        const btnClose = document.createElement("button");
        btnClose.className = "btn";
        btnClose.innerText = "Fechar Ticket";
        btnClose.addEventListener("click", function(){
          closeTicket(ticketId);
        });
        const p = document.createElement("p");
        p.className = "final-date";
        const now = new Date();
        p.innerHTML = `Ticket <b>${tickets[ticketId].number}</b> finalizado em: ${now.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit", hour12:false })}`;
        finalDiv.style.display = "flex";
        finalDiv.style.justifyContent = "space-between";
        finalDiv.style.alignItems = "center";
        finalDiv.appendChild(btnClose);
        finalDiv.appendChild(p);
        container.appendChild(finalDiv);
      }
    }
  </script>
</body>
</html>
